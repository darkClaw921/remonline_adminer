# Архитектура проекта Remonline Adminer

## Обзор
Приложение на FastAPI для работы с API Remonline, предоставляющее возможность управлять и просматривать данные о товарах, остатках и складах.

## Технологии
- **Python 3.12**
- **FastAPI** - веб-фреймворк
- **SQLAlchemy** - ORM для работы с базой данных
- **SQLite3** - база данных
- **httpx** - асинхронный HTTP клиент для работы с API
- **Pydantic** - валидация данных
- **loguru** - логирование
- **pytest** - тестирование

## Структура проекта

```
remonline_adminer/
├── main.py                          # Точка входа в приложение
├── flow.py                          # Одноразовый/CLI-флоу: синхронизация складов в БД
├── pyproject.toml                   # Конфигурация зависимостей
├── architecture.md                  # Этот файл
├── app/                             # Основное приложение
│   ├── api/                         # API endpoints
│   │   ├── __init__.py
│   │   ├── schemas.py               # Pydantic схемы для API
│   │   └── routes/                  # API роуты
│   │       ├── warehouses.py        # Роуты для складов
│   │       ├── products.py          # Роуты для товаров
│   │       ├── stocks.py            # Роуты для остатков
│   │       └── tabs.py              # Роуты для вкладок и подвкладок
│   ├── core/                        # Ядро приложения
│   │   └── config.py                # Конфигурация приложения
│   ├── models/                      # Модели базы данных
│   │   ├── __init__.py
│   │   ├── database.py              # Настройка базы данных
│   │   ├── warehouse.py             # Модель склада
│   │   ├── product.py               # Модель товара
│   │   ├── stock.py                 # Модель остатков
│   │   ├── last_update.py           # Модель последнего обновления
│   │   └── tab.py                   # Модели вкладок, подвкладок и товаров в подвкладках
│   ├── services/                    # Бизнес-логика
│   │   ├── __init__.py
│   │   ├── remonline_service.py     # Сервис для работы с API Remonline
│   │   └── background_service.py    # Сервис фоновых задач
│   ├── static/                      # Статические файлы
│   │   ├── css/
│   │   │   ├── products.css         # Стили таблицы товаров
│   │   │   └── tabs.css             # Стили системы вкладок
│   │   ├── js/
│   │   │   ├── products.js          # Логика таблицы товаров
│   │   │   ├── tabs.js              # Менеджер системы вкладок
│   │   │   └── tab.js               # Класс для управления вкладкой
│   │   └── products.html            # HTML страница товаров
│   └── tests/                       # Тесты
│       ├── __init__.py
│       ├── conftest.py              # Конфигурация тестов
│       ├── test_api.py              # Тесты API
│       └── test_integration.py      # Интеграционные тесты
├── migrations/                      # SQL миграции
│   └── 001_create_tabs.sql          # Миграция для создания таблиц вкладок
```

## Модели данных

### Warehouse (Склад)
- `id` - первичный ключ
- `remonline_id` - ID в системе Remonline
- `name` - название склада
- `address` - адрес склада
- `is_active` - активен ли склад
- `created_at` - дата создания
- `updated_at` - дата обновления

### Product (Товар)
- `id` - первичный ключ
- `remonline_id` - ID в системе Remonline
- `name` - название товара
- `sku` - артикул
- `barcode` - штрих-код
- `description` - описание
- `price` - цена
- `category` - категория
- `is_active` - активен ли товар
- `created_at` - дата создания
- `updated_at` - дата обновления

### Stock (Остатки)
- `id` - первичный ключ
- `warehouse_id` - ID склада
- `product_id` - ID товара
- `quantity` - общее количество
- `reserved_quantity` - зарезервированное количество
- `available_quantity` - доступное количество
- `created_at` - дата создания
- `updated_at` - дата обновления

### LastUpdate (Последнее обновление)
- `id` - первичный ключ
- `entity_type` - тип сущности (warehouses, products_stocks)
- `last_updated` - время последнего обновления
- `status` - статус обновления
- `error_message` - сообщение об ошибке

### Tab (Вкладка)
- `id` - первичный ключ
- `name` - название вкладки
- `order_index` - порядок отображения
- `is_active` - активна ли вкладка
- `created_at` - дата создания
- `updated_at` - дата обновления

### SubTab (Подвкладка)
- `id` - первичный ключ
- `tab_id` - ID родительской вкладки
- `name` - название подвкладки
- `order_index` - порядок отображения внутри вкладки
- `is_active` - активна ли подвкладка
- `created_at` - дата создания
- `updated_at` - дата обновления

### SubTabProduct (Товар в подвкладке)
- `id` - первичный ключ
- `subtab_id` - ID подвкладки
- `product_remonline_id` - ID товара в системе Remonline
- `custom_name` - переименованное название товара (опционально)
- `custom_category` - переименованная категория товара (опционально)
- `order_index` - порядок отображения в подвкладке
- `is_active` - активен ли товар в подвкладке
- `created_at` - дата создания
- `updated_at` - дата обновления

## API Endpoints

### Склады (/api/v1/warehouses/)
- `GET /` - получить все склады
  - Параметры: skip, limit, active_only (по умолчанию true)
- `GET /{warehouse_id}` - получить склад по ID
- `GET /remonline/{remonline_id}` - получить склад по Remonline ID

### Товары (/api/v1/products/)
- `GET /` - получить все товары с базовыми фильтрами
  - Параметры: name, sku, category, is_active, skip, limit
- `GET /filtered` - получить товары с расширенными фильтрами по складам и остаткам
  - Параметры: name, sku, category, warehouse_ids, price_min, price_max, stock_min, stock_max, sort_by, sort_order, skip, limit
  - Поддерживает фильтрацию по конкретным складам и диапазонам остатков
  - Сортировка по складам: sort_by=wh_{warehouse_remonline_id}
- `GET /{product_id}` - получить товар по ID
- `GET /remonline/{remonline_id}` - получить товар по Remonline ID
- `POST /{product_id}/refresh` - принудительно обновить товар и его остатки (по активным складам)

### Остатки (/api/v1/stocks/)
- `GET /` - получить все остатки с фильтрами
  - Параметры: warehouse_id, product_id, min_quantity, max_quantity, include_details, skip, limit
- `GET /{stock_id}` - получить остаток по ID
- `GET /warehouse/{warehouse_id}` - получить остатки на складе
- `GET /product/{product_id}` - получить остатки товара по всем складам
 - `POST /sync_all` - запустить автосинхронизацию остатков по всем активным складам (неблокирующе)
 - `GET /sync_progress` - получить текущий прогресс автосинхронизации (processed/total, статус)

### Вкладки (/api/v1/tabs/)
- `GET /` - получить все вкладки
  - Параметры: skip, limit, active_only (по умолчанию true)
- `POST /` - создать новую вкладку
- `GET /{tab_id}` - получить вкладку по ID
- `PUT /{tab_id}` - обновить вкладку
- `DELETE /{tab_id}` - удалить вкладку
- `POST /{tab_id}/reorder` - изменить порядок вкладки

### Подвкладки (/api/v1/tabs/)
- `GET /{tab_id}/subtabs` - получить подвкладки для вкладки
- `POST /{tab_id}/subtabs` - создать подвкладку
- `GET /subtabs/{subtab_id}` - получить подвкладку по ID (с товарами)
- `PUT /subtabs/{subtab_id}` - обновить подвкладку
- `POST /subtabs/{subtab_id}/reorder` - изменить порядок подвкладки
- `DELETE /subtabs/{subtab_id}` - удалить подвкладку

### Товары в подвкладках (/api/v1/tabs/)
- `GET /subtabs/{subtab_id}/products` - получить товары подвкладки
- `POST /subtabs/{subtab_id}/products` - добавить товары в подвкладку (массив product_remonline_ids)
- `POST /subtabs/{subtab_id}/products/single` - добавить один товар в подвкладку
- `PUT /subtabs/products/{product_id}` - обновить товар в подвкладке (переименование)
- `DELETE /subtabs/{subtab_id}/products/{product_remonline_id}` - удалить товар из подвкладки по Remonline ID
- `DELETE /subtabs/products/{product_id}` - удалить товар из подвкладки по ID записи (обратная совместимость)

Поведение автосинхронизации:
- Приоритет — запросы к API: страницы остатков по складам запрашиваются пачками по 3 асинхронных запроса в секунду (до 3 складов одновременно).
- После получения результатов из API выполняются пакетные апсерты (товары и остатки) одной транзакцией на каждую пачку.
- Прогресс считается по складам: как только у склада приходит пустая страница — он помечается завершённым.

## Сервисы

### RemonlineService
Отвечает за взаимодействие с API Remonline:
- Получение данных из API
- Синхронизация складов
- Синхронизация товаров и остатков
- Обработка ошибок API

### BackgroundService
Управляет фоновыми задачами:
- Периодическое обновление данных
- Запуск/остановка фоновых процессов
- Логирование процесса обновления

## Конфигурация

### Переменные окружения
- `REMONLINE_API_KEY` - API ключ Remonline
- `DATABASE_URL` - URL базы данных (по умолчанию SQLite)
- `DEBUG` - режим отладки
- `LOG_LEVEL` - уровень логирования
- `UPDATE_INTERVAL_MINUTES` - интервал обновления данных

### Настройки по умолчанию
```python
REMONLINE_API_KEY = ""  # Должен быть установлен
DATABASE_URL = "sqlite:///./remonline.db"
DEBUG = False
LOG_LEVEL = "INFO"
UPDATE_INTERVAL_MINUTES = 30
```

## Запуск приложения

### Установка зависимостей
```bash
uv sync
```

### Запуск приложения
```bash
uv run main.py
```

Приложение будет доступно на `http://localhost:8000`
Документация API: `http://localhost:8000/docs`

### Ручной запуск синхронизации складов (CLI)
```bash
uv run flow.py
```
Назначение: выполнить `async`-флоу `sync_warehouses_to_db()`, который через `RemonlineService` получает все склады и записывает/обновляет их в БД. Логи — через `loguru`.

## Запуск тестов

```bash
# Все тесты
uv run pytest

# С конкретным файлом
uv run pytest app/tests/test_api.py

# С интеграционными тестами
uv run pytest app/tests/test_integration.py -v
```

## Фоновые задачи

Приложение автоматически запускает фоновые задачи при старте:
1. Синхронизация складов из API Remonline
2. Синхронизация товаров и остатков
3. Периодическое обновление данных (каждые 30 минут)

## Логирование

Используется библиотека `loguru` для структурированного логирования:
- INFO: общая информация о работе
- ERROR: ошибки выполнения
- DEBUG: детальная отладочная информация (в режиме DEBUG)

## Безопасность

- API ключ Remonline хранится в переменных окружения
- CORS настроен для всех источников (для разработки)
- Валидация входных данных через Pydantic
- Асинхронная обработка запросов

## Мониторинг

- `/health` - проверка здоровья приложения
- `/` - базовая информация о приложении
- Логи фоновых задач
- Статус подключения к базе данных

## Разработка

### Добавление новых моделей
1. Создать файл в `app/models/`
2. Импортировать в `app/models/__init__.py`
3. Добавить в `Base.metadata.create_all()`

### Добавление новых API endpoints
1. Создать роуты в `app/api/routes/`
2. Импортировать в `app/api/__init__.py`
3. Добавить схемы в `app/api/schemas.py`

### Добавление новых сервисов
1. Создать сервис в `app/services/`
2. Импортировать в `app/services/__init__.py`
3. Подключить в основном приложении

## Производительность

- Асинхронные запросы к API Remonline
- Пагинация результатов
- Оптимизированные SQL запросы
- Фоновое обновление данных

## Фронтенд (простая страница просмотра товаров)

- Статика смонтирована как `GET /static/*` из директории `app/static`
- Страница: `GET /products` возвращает `app/static/products.html`
- Дизайн: Bootstrap 5 (CDN)
- Функциональность страницы:
  - Таблица товаров со столбцами по складам
  - Поиск по названию/SKU — перемещён в правый верхний угол карточки
  - Кнопки «Обновить» и «Автосинхронизация» — перемещены влево, рядом с прогресс-баром
  - Удалены индикатор «Склады: …» в правой верхней части и фильтры «Цена»/«Остаток»
  - Сортировка: по клику на заголовки таблицы (кроме колонки Фото), поддерживаются колонки: Название, Категория, Цена (базовая), все ценовые (по id), Общий остаток, а также по каждому складу. При повторном клике направление меняется `asc`/`desc`.
  - Перетаскивание столбцов: все заголовки таблицы поддерживают drag-and-drop для изменения порядка столбцов, порядок сохраняется в localStorage
  - Удалены суммарные бейджи остатков по складам, размер страницы перенесён в низ таблицы.
- Используемые API эндпоинты:
  - `GET /api/v1/warehouses/?active_only=true&limit=1000` — загрузка активных складов для фильтра и заголовков таблицы
  - `GET /api/v1/products/?skip=&limit=&name=` — загрузка списка товаров без фильтров (при обычном просмотре)
  - `GET /api/v1/products/filtered?warehouse_ids=&stock_min=&...` — загрузка товаров с серверными фильтрами (при нажатии "Применить"). Параметры `sort_by/sort_order` передаются только для поддерживаемых ключей (name/category/price/total/wh_...).
  - `GET /api/v1/stocks/product/{product_id}?include_details=true` — загрузка остатков товара по всем складам и маппинг по `warehouse.remonline_id`
  - `POST /api/v1/products/{id}/refresh` — принудительное обновление одного товара
  - `POST /api/v1/stocks/sync_all` — старт полной синхронизации остатков по складам
  - `GET /api/v1/stocks/sync_progress` — прогресс полной синхронизации

Страница находится в `app/static/products.html`. Маршрут и монтирование статических файлов добавлены в `main.py`.

Стили и скрипты:
- `app/static/css/products.css` — стили таблицы, колонок, миниатюр, цен и окна предпросмотра; курсор `pointer` на сортируемых заголовках; стили для drag-and-drop столбцов (курсор grab/grabbing, визуальная обратная связь)
- `app/static/css/tabs.css` — стили системы вкладок: интерфейс вкладок с горизонтальным скроллингом, подвкладки, drag-and-drop для перемещения вкладок, адаптивный дизайн
- `app/static/js/products.js` — загрузка данных, рендер таблицы (в т.ч. цен), hover-превью изображений, фильтры, сортировка по клику на заголовки, и drag-and-drop для изменения порядка столбцов. Динамическое управление заголовками и колонками таблицы в зависимости от выбранных складов. Числовая пагинация: блок страниц внизу вида «< 1 2 3 4 ... > N», селектор размера страницы `25/50/100` перенесён вниз. Сохранение порядка столбцов в localStorage (ключ `columnOrder.v1`). Интеграция с системой вкладок для фильтрации товаров по подвкладкам.
- `app/static/js/tabs.js` — класс TabsManager для управления системой вкладок: создание, переименование, удаление, перемещение вкладок; управление подвкладками; горизонтальный скролл при переполнении; callback для уведомления о смене активной подвкладки
- `app/static/js/tab.js` — классы Tab и Subtab для управления вкладками и подвкладками: создание DOM элементов, обработка событий, управление товарами в подвкладках, drag-and-drop перемещение, переименование. Включает модальное окно для добавления/удаления товаров в подвкладки с поиском и двусторонними списками. Поддерживает inline-редактирование кастомных названий и категорий товаров прямо в модальном окне.

Схемы: `ProductResponse` включает `images_json` и `prices_json` для фронтенда.
Фронтенд (микро-UI):
- app/static/products.html — Bootstrap-таблица товаров, колонки цен (48388, 97150, 377836, 555169), фото с hover-превью, колонка Товар (RemID, дата, SKU), Категория, Общий остаток
- Статика: /static; роут /products отдаёт products.html
- CSS: app/static/css/products.css — таблица, миниатюры, цены, hover-превью
- JS: app/static/js/products.js — загрузка данных, рендер остатков и цен, предпросмотр фото
  - Управление столбцами: сохранение видимости в `localStorage` (ключ `columnsVisibility.v1`), чекбоксы для основных и складских колонок в модальном окне, моментальное применение без перезагрузки
  - Перетаскивание столбцов: HTML5 drag-and-drop API для изменения порядка столбцов, сохранение порядка в `localStorage` (ключ `columnOrder.v1`), визуальная обратная связь при перетаскивании

API:
- /api/v1/products/ — список товаров (используются поля images_json, prices_json)
- /api/v1/stocks/product/{id} — остатки товара по складам

## Система вкладок

### Функциональность
- **Создание и управление вкладками**: возможность создавать, переименовывать, удалять и перемещать вкладки
- **Подвкладки**: внутри каждой вкладки можно создавать подвкладки по аналогичному принципу
- **Горизонтальный скролл**: при переполнении вкладок появляются кнопки прокрутки влево/вправо
- **Товары в подвкладках**: в подвкладки можно добавлять конкретные товары по их Remonline ID
- **Кастомизация товаров**: возможность задавать кастомное название и категорию для товаров в подвкладках
- **Inline-редактирование**: прямое редактирование названий и категорий товаров в модальном окне управления
- **Фильтрация**: при выборе подвкладки таблица товаров фильтруется по товарам из этой подвкладки
- **Визуальные индикаторы**: кастомные названия и категории отмечаются зеленой галочкой ✓ в основной таблице
- **Отображение оригинальных данных**: показ исходных названий и категорий товаров для справки

### Структура
- **Tab** - основная вкладка с названием и порядком отображения
- **SubTab** - подвкладка внутри вкладки
- **SubTabProduct** - товар в подвкладке с возможностью кастомного названия и категории

### API endpoints
- Полный CRUD для вкладок, подвкладок и товаров в подвкладках
- Поддержка изменения порядка вкладок через drag-and-drop
- Автоматическое создание базовой подвкладки "Основной список" при создании новой вкладки

### База данных
- Миграция `migrations/001_create_tabs.sql` создаёт необходимые таблицы
- Поддержка каскадного удаления и индексов для производительности
- Триггеры для автоматического обновления `updated_at`

Схемы:
- ProductResponse: добавлены images_json, prices_json
- TabResponse, SubTabResponse, SubTabProductResponse: полные схемы для системы вкладок